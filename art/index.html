<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Art - Artwork by Shauna McNally">
    <title>Art | Shauna McNally</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body class="cart-page">
    <div class="container">
        <header>
            <nav class="menu" role="navigation" aria-label="Main navigation">
                <a href="/index.html" class="logo">ShaunaMcNally.Com</a>
                <div class="menu-links">
                    <a href="/about/index.html" class="site-link">About</a>
                    <a href="/art/index.html" class="site-link">Art</a>
                    <a href="/cart/index.html" class="site-link">Cart</a>
                </div>
            </nav>
        </header>

        <main>
            <article class="artwork-page">
                <h1>Art</h1>

                <section class="artwork-list">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center;">Available Prints</h2>
                    <div id="loading-message" style="text-align: center; padding: 2rem;">
                        <p>Loading products...</p>
                    </div>
                    <div id="error-message" style="display: none; text-align: center; padding: 2rem; color: #d32f2f;">
                        <p id="error-text">Failed to load products. Please try again later.</p>
                    </div>
                    <ul id="products-list" class="artwork-items" style="display: none;">
                        <!-- Products will be dynamically inserted here -->
                    </ul>
                </section>
            </article>
        </main>
    </div>

    <script src="/script.js"></script>
    <script>
        // Fetch and display products from Stripe
        async function loadProducts() {
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const productsList = document.getElementById('products-list');
            
            try {
                const response = await fetch('/api/products', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    // Try to get error details from response
                    let errorMessage = 'Failed to fetch products';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        if (errorData.details) {
                            console.error('API Error Details:', errorData.details);
                        }
                    } catch (e) {
                        // If response isn't JSON, use status text
                        errorMessage = `Failed to fetch products (${response.status}: ${response.statusText})`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                const products = data.products || [];
                
                // Debug: Log first product to see image data
                if (products.length > 0) {
                    console.log('Sample product data:', products[0]);
                    console.log('Product image:', products[0].image);
                }
                
                if (products.length === 0) {
                    loadingMessage.innerHTML = '<p>No products available at this time.</p>';
                    return;
                }
                
                // Hide loading message
                loadingMessage.style.display = 'none';
                
                // Clear existing items
                productsList.innerHTML = '';
                
                // Render each product
                products.forEach(product => {
                    const listItem = document.createElement('li');
                    listItem.className = 'artwork-item';
                    
                    // Get image URL first
                    const imageUrl = product.image || (product.images && product.images.length > 0 ? product.images[0] : null);
                    
                    // Debug: Log image URL for this product
                    if (imageUrl) {
                        console.log(`Image URL for ${product.name}:`, imageUrl);
                    }
                    
                    // Build the product display with optional image
                    let imageHtml = '';
                    if (imageUrl) {
                        imageHtml = `
                            <div class="artwork-tile-image" style="width: 100px; height: 100px; margin-right: 1rem; flex-shrink: 0; border: 1px solid #e0e0e0; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <img 
                                    src="${escapeHtml(imageUrl)}" 
                                    alt="${escapeHtml(product.name)}"
                                    style="width: 100%; height: 100%; object-fit: contain; display: block;"
                                    loading="lazy"
                                    onload="console.log('Image loaded:', '${escapeHtml(product.name)}');"
                                    onerror="console.error('Image failed to load:', '${escapeHtml(product.name)}', this.src); this.style.display='none'; this.parentElement.innerHTML='<span style=\'color:#999;font-size:0.8rem;\'>No image</span>';"
                                >
                            </div>
                        `;
                    } else {
                        // Show placeholder if no image
                        imageHtml = `
                            <div class="artwork-tile-image" style="width: 100px; height: 100px; margin-right: 1rem; flex-shrink: 0; border: 1px solid #e0e0e0; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999; font-size: 0.8rem;">No image</span>
                            </div>
                        `;
                    }
                    
                    listItem.innerHTML = `
                        <div class="cart-item-row">
                            <div class="cart-item-row-content" style="display: flex; align-items: center; gap: 1rem;">
                                ${imageHtml}
                                <div style="flex: 1;">
                                    <a href="${product.url}" class="artwork-link">
                                        <span class="artwork-title">${escapeHtml(product.name)}</span>
                                    </a>
                                    <span class="cart-item-price">â‚¬${product.price}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Store product info in data attributes for cart functionality (after imageUrl is defined)
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-primary cart-item-button';
                    button.setAttribute('data-product-id', product.id);
                    button.setAttribute('data-product-name', product.name);
                    button.setAttribute('data-product-price', product.price);
                    button.setAttribute('data-product-description', product.description || '');
                    if (imageUrl) {
                        button.setAttribute('data-product-image', imageUrl);
                    }
                    button.textContent = 'Add to Cart';
                    button.setAttribute('aria-label', `Add ${escapeHtml(product.name)} to cart`);
                    button.onclick = function() {
                        addItemToCart(product.id, this);
                    };
                    
                    // Append button to the cart-item-row
                    const row = listItem.querySelector('.cart-item-row');
                    row.appendChild(button);
                    
                    productsList.appendChild(listItem);
                });
                
                // Show products list (CSS will handle the layout via cart-page class)
                productsList.style.display = '';
                
            } catch (error) {
                console.error('Error loading products:', error);
                loadingMessage.style.display = 'none';
                const errorText = document.getElementById('error-text');
                if (errorText) {
                    errorText.textContent = error.message || 'Failed to load products. Please try again later.';
                }
                errorMessage.style.display = 'block';
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load products when page loads
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>
</html>

